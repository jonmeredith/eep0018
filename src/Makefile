# Copyright (c) 2008-2009 Paul J. Davis <paul.joseph.davis@gmail.com>
# Copyright (c) 2008-2009 Enrico Thierbach <eno@open-lab.org>
#
# This file is part of EEP0018, which is released under the MIT
# license.

# Point me to the erlang installation directory.

OTPROOT=/usr/local/lib/erlang

# Hopefully the rest works for everyone.

EIROOT=$(OTPROOT)/lib/$(shell ls $(OTPROOT)/lib/ | grep erl_interface)
ERTSROOT=$(OTPROOT)/$(shell ls $(OTPROOT) | grep erts)

INCLUDES = -I$(OTPROOT)/usr/include/
INCLUDES += -I$(EIROOT)/include

LIBS = -L$(EIROOT)/lib -lerl_interface -lei

include Makefile.$(shell uname -s)

CFLAGS = $(GCCFLAGS) $(INCLUDES)
LDFLAGS = $(GCCFLAGS) $(LIBS)

OBJECTS = \
	eep0018.o \
	ei_bin_buf.o \
	json_to_term.o \
	term_buf.o \
	term_to_json.o \
	yajl.o \
	yajl_encode.o \
	yajl_lex.o \
	yajl_buf.o \
	yajl_gen.o \
	yajl_parser.o

EBIN_DIR=../ebin
PRIV_DIR=../priv

DRIVER = $(PRIV_DIR)/eep0018_drv.so
BEAM = $(EBIN_DIR)/eep0018.beam

# -- rules --------------------------------------------------------------------

all: $(DRIVER) $(BEAM)

clean: 
	rm -f *.o $(BEAM) $(DRIVER)

$(DRIVER): $(OBJECTS)
	gcc -o $@ $^ $(LDFLAGS)

$(BEAM): eep0018.erl
	erlc +debug_info -o $(EBIN_DIR) $^

check:
	@true
